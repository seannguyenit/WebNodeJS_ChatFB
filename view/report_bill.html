<!doctype html>
<html lang="en">

<head>
    <title>Report</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="../css/style.css" />
    <link rel="stylesheet" type="text/css" href="../css/table.css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>

<body>
    <!-- Top Bar -->
    <section>
        <div class="col-md-12 d-flex topbar section_header">
            <div class="col-md-10 menu">
                <div id="main_menu">
                </div>
                <!-- <button href="btn btn-primary">Thông tin tài khoản</button>
                <button href="btn btn-primary" onclick="acc_logout()">Đăng xuất</button>
                <a class="text-info" href="facebook.com">Hỗ trợ - 090xxxxxx</a> -->
            </div>
            <div class="col-md-2">
                <img class="avata" src="../img/avatar.png" width="40" height="40" />
                <a id="user_info" class="header_account">Nguyen van A - CTV</a>
            </div>
        </div>
    </section>
    <!-- Content Bar -->
    <section>
        <div class="col-md-12 pl-0 pr-0 d-flex">
            <div class="col-md-12">
                <div class="link_map" id="linkmenu">
                </div>
                <hr />
                <div class="w-100 pt-3">
                    <a href="./report" class="btn btn-primary">Báo cáo tổng hợp</a>
                    <a href="./bill" class="btn btn-primary">Báo cáo đơn hàng</a>
                    <!-- <a href="#" class="btn btn-primary">Báo cáo nhân viên</a>
                    <a href="#" class="btn btn-primary">Báo cáo thu nhập</a> -->
                    <a href="./rpp" class="btn btn-primary">Báo cáo hàng hóa</a>
                </div>
                <hr />
                <div class="w-100 d-flex">
                    <div class="form-group w-25">
                        <label for="from_date">Từ ngày</label>
                        <input type="date" class="form-control" name="from_date" id="from_date"
                            aria-describedby="from_date" placeholder="yyyy-MM-dd">
                        <!-- <small id="from_date" class="form-text text-muted">Chọn ngày</small> -->
                    </div>
                    <div class="form-group w-25">
                        <label for="to_date">Đến ngày</label>
                        <input type="date" class="form-control" name="to_date" id="to_date" aria-describedby="to_date"
                            placeholder="yyyy-MM-dd">
                        <!-- <small id="to_date" class="form-text text-muted">Chọn ngày</small> -->
                    </div>
                    <div class="form-group w-25">
                        <label for="stt">Trạng thái</label>
                        <select required class="form-control" name="stt" id="stt">
                            <option value="3" selected>Tất cả</option>
                            <option value="0">Mới tạo</option>
                            <option style="background-color: springgreen;" value="1">Kế toán duyệt</option>
                            <option style="background-color: yellow;" value="2">Kế toán thu tiền</option>
                            <option style="background-color: green;" value="3">Thủ quỹ thu tiền</option>
                            <option style="background-color: red;" value="-1">Hủy</option>
                        </select>
                    </div>
                </div>
                <hr />
                <div class="text_title">
                    Báo cáo đơn hàng
                </div>
                <div id="content">
                    <button class="btn btn-primary" data-toggle="modal" onclick="load_general_report()"
                        data-target="#detailId">Tìm kiếm</button>
                    <table id="mainData" class="tablemanager table table-striped table-bordered table-sm"
                        cellspacing="0" width="100%">
                        <thead>
                            <!-- ['id','total','ck','user','group_name','customer','cus_name'] -->
                            <tr>
                                <th>ID FB</th>
                                <th>STT</th>
                                <th>Mã</th>
                                <th>Khách</th>
                                <th>CSKH</th>
                                <th>CTV</th>
                                <th>SDT</th>
                                <th>DC</th>
                                <th>Tp</th>
                                <th>Tổng(VND)</th>
                                <th>Cọc(VND)</th>
                                <th>Còn(VND)</th>
                                <th>CK(VND)</th>
                                <th>Trạng thái</th>
                                <th>KT</th>
                                <th>TQ</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>

                    <!-- <button class="btn btn-sm btn-primary" data-toggle="modal" data-target="#detailId">Tạo mới</button> -->
                </div>
            </div>
        </div>
    </section>
    <!-- Optional JavaScript -->

    <!-- Button trigger modal -->

    <!-- Modal -->
    <div class="modal fade" id="approve_modal" tabindex="-1" role="dialog" aria-labelledby="modelTitleId"
        aria-hidden="true">
        <div class="modal-dialog modal_multi_tab" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Duyệt đơn hàng</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body d-flex">
                    <div class="d-flex flex-wrap text-center w-50 p-1" style="justify-content: space-between;">
                        <div class="form-group w-50 mb-0">
                            <label for="status">Trạng thái : </label>
                            <label id="status">Họ tên</label>
                        </div>
                        <div class="form-group w-50 mb-0">
                            <label for="real_name">Khách hàng : </label>
                            <label id="real_name">Họ tên</label>
                        </div>
                        <div class="form-group w-50 mb-0">
                            <label for="code">Mã đơn : </label>
                            <label id="code">XYZ</label>
                        </div>
                        <div class="form-group w-50 mb-0">
                            <label for="time">Thời gian : </label>
                            <label id="time">XYZ</label>
                        </div>
                        <div class="form-group w-50 mb-0">
                            <label for="total">Tổng : </label>
                            <label class="format_vnd" id="total">XYZ</label>
                        </div>
                        <div class="form-group w-50 d-flex mb-0">
                            <label for="money_receive">Thu thêm: </label>
                            <input class="vnd_convert" style="width: 50%; margin-top: -10px;" id="money_receive"
                                data-value="0" value="0"></input>
                            <button style="margin-top: -10px;" id="save_money" onclick="save_money()"
                                class="btn btn-sm btn-primary">Lưu</button>
                        </div>
                        <div class="form-group w-50 mb-0">
                            <label for="CTV">CTV : </label>
                            <label id="CTV">XYZ</label>
                        </div>
                        <div class="form-group w-50 mb-0">
                            <label for="CSKH">CSKH : </label>
                            <label id="CSKH">CSKH</label>
                        </div>
                        <div class="form-group w-100">
                            <table id="details_data" class="table table-striped table-bordered table-sm" cellspacing="0"
                                width="100%">
                                <thead>
                                    <!-- ['id','total','ck','user','group_name','customer','cus_name'] -->
                                    <tr>
                                        <th>Tên hàng hóa</th>
                                        <th>Số lượng</th>
                                        <th>Đơn giá (VND)</th>
                                        <th>Thành tiền (VND)</th>
                                        <!-- <th>Chiết khấu (%)</th>
                                        <th>Chiết khấu (VND)</th> -->
                                    </tr>
                                </thead>
                                <tbody>

                                </tbody>
                            </table>
                        </div>
                        <div class="form-group w-100">
                            <table id="money_data" class="table table-striped table-bordered table-sm" cellspacing="0"
                                width="100%">
                                <thead>
                                    <!-- ['id','total','ck','user','group_name','customer','cus_name'] -->
                                    <tr>
                                        <th colspan="8">Lịch sử nhận tiền</th>
                                    </tr>
                                    <tr>
                                        <th>Lần thứ</th>
                                        <th>Số tiền (VND)</th>
                                        <th>Người nhận</th>
                                        <th>Thời gian</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>

                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="d-flex flex-wrap text-center w-50 p-1" style="justify-content: space-between;">
                        <div class="form-group w-100">
                            <label for="accountant_note">Ghi chú (KT) : </label>
                            <textarea class="w-100" rows="3" id="accountant_note"></textarea>
                            <button class="btn-sm btn-primary" onclick="save_bill_note('accountant')">KT Lưu</button>
                        </div>
                        <hr />
                        <div class="form-group w-100">
                            <label for="accepted_note">Ghi chú (TQ) : </label>
                            <textarea class="w-100" rows="3" id="accepted_note"></textarea>
                            <button class="btn-sm btn-primary" onclick="save_bill_note('accepted')">TQ Lưu</button>
                        </div>
                        <hr />
                        <div class="form-group w-100">
                            <label for="reject_note">Lý do hủy : </label>
                            <textarea class="w-100" rows="3" id="reject_note"></textarea>
                            <button class="btn-sm btn-primary" onclick="save_bill_note('reject')">Lưu</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="cancel_this_bill()" class="btn btn-danger"
                        style="position: absolute;left: 10px;">Hủy</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                    <button type="button" id="bt_change_stt" onclick="set_stt()" class="btn btn-primary">Duyệt</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>

    <script src="../js/main.js"></script>
    <script src="../js/menu_function.js"></script>
    <script src="../js/table.js"></script>
    <script>
        var is_first = true;
        var lst_cr_data;
        var cr_bill;
        load_default_date();
        load_general_report();
        function load_default_date() {
            var now_t = new Date();
            var m = (now_t.getMonth() + 1) < 10 ? `0${now_t.getMonth() + 1}` : (now_t.getMonth() + 1);
            var date = now_t.getDate();
            var y = now_t.getFullYear();
            document.getElementById('from_date').value = `${y}-${m}-01`;
            document.getElementById('to_date').value = `${y}-${m}-${date < 10 ? ('0' + date) : date}`;
        }

        function set_link_menu(m, t) {
            var ae = document.createElement('a');
            ae.href = '/';
            ae.innerText = 'Trang chủ';
            var me = document.createElement('a');
            me.href = `/home/${m}`;
            me.innerText = t || m;
            var sign = document.createElement('span');
            sign.innerText = ' > ';
            var ct = document.getElementById('linkmenu');
            ct.innerHTML = '';
            ct.appendChild(ae);
            ct.appendChild(sign);
            ct.appendChild(me);
        }

        set_link_menu('report', 'Báo cáo đơn hàng');
        async function load_general_report() {

            var from = document.getElementById('from_date').value;
            var to = document.getElementById('to_date').value;
            var stt = document.getElementById('stt').value;
            var rs = await report_bill(from, to, stt);
            lst_cr_data = rs;
            var tb = document.getElementById('mainData').querySelector('tbody');
            tb.innerHTML = '';
            if (rs != undefined) {
                // nhom, sl don hang, tong tien , tong ck
                rs = await add_stt_column(rs);
                tb.innerHTML += allRow(rs, tb, ['customer', 'stt', 'code', 'cus_name', 'CSKH', 'CTV', 'phone', 'address', 'city', 'total', 'money_receive', 'res_money', 'ck', 'status_id', 'accountant_note', 'accepted_note'], null, [{ title: 'Duyệt', class: 'btn-primary', action: 'approve_bill' }], false).innerHTML;
                covertBillStatus(tb, 13);
                // if (is_first) load_list_user(rs[0]);
            }
            if (is_first) {
                $('.tablemanager').tablemanager({
                    firstSort: [[3, 0], [2, 0], [1, 'asc']],
                    disable: ["last"],
                    appendFilterby: true,
                    dateFormat: [[4, "mm-dd-yyyy"]],
                    debug: true,
                    vocabulary: {
                        voc_filter_by: 'Lọc theo',
                        voc_type_here_filter: 'từ khóa',
                        voc_show_rows: 'Số dòng mỗi trang'
                    },
                    pagination: true,
                    showrows: [100, 200],
                    disableFilterBy: [1],
                    // group_by_col: 5
                });
                is_first = false;
            }
            format_vnd();
        }

        function open_bill(id = 0, acc_id = 0) {
            window.open(`/bill/details?id=${id}`, '_blank');
        }

        async function approve_bill(id = 0, acc_id = 0) {
            cr_bill = lst_cr_data.find((f) => { return f.id == id });
            var cr_bill_details = await get_bill_products(id);
            if (cr_bill) {
                document.getElementById('status').innerText = cr_bill.status || '';
                document.getElementById('real_name').innerText = cr_bill.cus_name || '';
                document.getElementById('code').innerText = cr_bill.code || '';
                document.getElementById('time').innerText = cr_bill.time || '';
                document.getElementById('total').innerText = cr_bill.total || '';
                document.getElementById('money_receive').value = '0';
                document.getElementById('CSKH').innerText = cr_bill.CSKH || '';
                document.getElementById('CTV').innerText = cr_bill.CTV || '';
                document.getElementById('accountant_note').value = cr_bill.accountant_note || '';
                document.getElementById('accepted_note').value = cr_bill.accepted_note || '';
                document.getElementById('reject_note').value = cr_bill.reject_note || '';
            }
            if (cr_bill_details) {
                var tb2 = document.getElementById('details_data').querySelector('tbody');
                tb2.innerHTML = '';
                var lst_ = cr_bill_details;
                if (lst_) {
                    lst_.forEach(item => {
                        tb2.innerHTML += `<tr>
                            <td>${item.product_name}</td>
                            <td>${item.quantity}</td>
                            <td class="format_vnd">${item.price}</td>
                            <td class="format_vnd">${(item.quantity * item.price)}</td>
                            <td></td>
                        </tr>`;
                    });
                }
            }
            await load_money_count();
            format_vnd();
            init_status_current_bill();
            $('#approve_modal').modal({ show: true });
            set_button_form();
        }

        async function load_money_count() {
            var lst_money_count = await get_all_money_count(cr_bill.id);
            if (lst_money_count) {
                var tb3 = document.getElementById('money_data').querySelector('tbody');
                tb3.innerHTML = '';
                lst_money_count.forEach((item) => {
                    tb3.innerHTML += `<tr>
                            <td>${lst_money_count.indexOf(item) + 1}</td>
                            <td class="format_vnd">${item.money}</td>
                            <td>${item.rec_user}</td>
                            <td>${format_time(item.time)}</td>
                            <td><button class="btn btn-sm btn-danger" disabled>Xóa</button></td>
                        </tr>`;
                });
            }
        }

        async function save_money() {
            if (!confirm('Bạn có chắc chắn muốn thay đổi dữ liệu ?')) {
                return;
            }
            let money = document.getElementById('money_receive').dataset.value;
            if (money <= 0 || !cr_bill.id) {
                alert('Số tiền phải lớn hơn 0');
                return;
            }
            if (isNaN(money)) {
                alert('Số tiền không đúng');
                return;
            }
            await insert_money_count(cr_bill.id, money);
            document.getElementById('money_receive').value = 0;
            // document.getElementById('money_receive').dataset.value = 0;
            await load_money_count();
            format_vnd();
            load_general_report();
        }

        async function cancel_this_bill() {
            if (!confirm('Bạn có chắc chắn muốn thay đổi dữ liệu ?')) {
                return;
            }
            await set_bill_stt('huy', cr_bill.id, -1, document.getElementById('reject_note').value);
            $('#approve_modal').modal({ show: false });
            load_general_report();
        }

        async function set_stt() {
            if (!confirm('Bạn có chắc chắn muốn thay đổi dữ liệu ?')) {
                return;
            }
            if (cr_bill.status_id == -1 || cr_bill.status_id == 3) {
                alert('Không đúng trạng thái !');
                return;
            }
            var tg_stt = 1;
            var type = 'kt1';
            // if(cr_bill.status_id==0) tg_stt = 1;
            if (cr_bill.status_id == 1) {
                tg_stt = 2;
                type = 'kt2';
            }
            if (cr_bill.status_id == 2) {
                tg_stt = 3;
                type = 'tq';
            }
            await set_bill_stt(type, cr_bill.id, tg_stt);
            // $('#approve_modal').modal({ show: false });
            alert('Xong !');
            $('#approve_modal').modal({ show: false });
            load_general_report();
        }

        async function save_bill_note(type) {
            if (!confirm('Bạn có chắc chắn muốn thay đổi dữ liệu ?')) {
                return;
            }
            switch (type) {
                case 'accountant':
                    set_bill_note('kt', cr_bill.id, document.getElementById('accountant_note').value)
                    break;
                case 'accepted':
                    set_bill_note('tq', cr_bill.id, document.getElementById('accepted_note').value)
                    break;
                case 'reject':
                    set_bill_note('huy', cr_bill.id, document.getElementById('reject_note').value)
                    break;
                default:
                    break;
            }
            alert('Xong !');
            $('#approve_modal').modal({ show: false });
            load_general_report();
        }

        async function init_status_current_bill() {
            if (cr_bill) {
                var lst_bt = document.getElementById('approve_modal').querySelectorAll('button');
                var lst_input = document.getElementById('approve_modal').querySelectorAll('input');
                var lst_ta = document.getElementById('approve_modal').querySelectorAll('textarea');
                var arr = [...lst_bt, ...lst_input, ...lst_ta];
                if (cr_bill.status_id == -1) {
                    arr.forEach((i) => {
                        if (i.onclick == true) {
                            i.disabled = true;
                        }
                    });
                } else {
                    arr.forEach((i) => {
                        if (i.onclick == true) {
                            i.disabled = false;
                        }
                    });
                }
            }
        }

        async function set_button_form() {
            var bt_save = document.getElementById('save_money');
            bt_save.style.display = 'block'
            var bt = document.getElementById('bt_change_stt');
            var str = 'Duyệt';
            if (cr_bill) {
                switch (cr_bill.status_id) {
                    case 0:
                        bt.innerText = 'KẾ TOÁN DUYỆT';
                        bt.style.backgroundColor = 'springgreen';
                        break;
                    case 1:
                        bt.innerText = 'KẾ TOÁN THU TIỀN';
                        bt.style.backgroundColor = 'yellow';
                        break;
                    case 2:
                        bt.innerText = 'THỦ QUỸ THU TIỀN';
                        bt.style.backgroundColor = 'green';
                        bt_save.style.display = 'none'
                        break;
                    case 3:
                        bt_save.style.display = 'none'
                        bt.style.display = 'none';
                        break;
                    case -1:
                        bt_save.style.display = 'none'
                        bt.style.display = 'none';
                        break;
                    default:
                        break;
                }
            }
        }

    </script>
</body>

</html>